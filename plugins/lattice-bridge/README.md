# lattice-bridge OpenCode Plugin

This plugin streams OpenCode session activity to the Lattice HTTP event bridge.

## Installation

Install the plugin in your project (or globally) using the OpenCode CLI. The
plugin ships with Lattice under `plugins/lattice-bridge`.

```bash
# From your project directory (where opencode.jsonc lives)
opencode install "$LATTICE_ROOT/plugins/lattice-bridge"
```

If `LATTICE_PLUGIN_AUTO_INSTALL` is left at its default value (`1`), Lattice
automatically runs this command when preparing OpenCode.

## Configuration

The plugin requires lattice to pass a few environment variables when spawning an
OpenCode session.

| Variable                 | Required | Description                                                     |
| ------------------------ | -------- | --------------------------------------------------------------- |
| `LATTICE_BRIDGE_URL`     | ✅       | Base URL for the Go event bridge (e.g. `http://127.0.0.1:8765`) |
| `LATTICE_SESSION_ID`     | ✅       | Per-session UUID generated by Lattice                           |
| `LATTICE_MODULE_ID`      | ✅       | Module identifier that owns the session                         |
| `LATTICE_WORKFLOW_ID`    | ✅       | Active workflow ID                                              |
| `LATTICE_BRIDGE_TOKEN`   | ❌       | Bearer token if bridge authentication is enabled                |
| `LATTICE_BRIDGE_VERSION` | ❌       | Contract version (defaults to `1`)                              |

Plugin-specific options can also be set via `opencode.jsonc` under
`plugin.lattice-bridge`, for example:

```jsonc
{
  "plugin": {
    "lattice-bridge": {
      "serverUrl": "http://127.0.0.1:8765",
      "maxRetries": 5,
      "retryDelayMs": 500,
    },
  },
}
```

Environment variables always win over `opencode.jsonc` values, ensuring Lattice
can provide runtime details such as session IDs.

## Event Coverage

The plugin subscribes to the following OpenCode events and converts them into
the bridge schema:

- `session.start`
- `session.end`
- `model.request`
- `model.response`
- `model.error`
- `tool.call`
- `tool.result`
- `error`

Payloads larger than 1 MB are automatically truncated before sending so the
bridge’s request limit is respected.

## Development

```
npm install
npm run build
```

Build artifacts are emitted into `dist/` and the package entry point references
the compiled CommonJS output.
